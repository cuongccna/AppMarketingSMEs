// Prisma Schema for LAR - Local AI Responder
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== Authentication ====================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  password      String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts      Account[]
  sessions      Session[]
  businesses    Business[]
  subscription  Subscription?
  usageStats    UsageStats[]
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ==================== Subscription & Pricing ====================

enum SubscriptionPlan {
  FREE
  ESSENTIAL
  PROFESSIONAL
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  TRIALING
}

model Subscription {
  id                   String             @id @default(cuid())
  userId               String             @unique
  plan                 SubscriptionPlan   @default(FREE)
  status               SubscriptionStatus @default(ACTIVE)
  stripeCustomerId     String?
  stripeSubscriptionId String?
  stripePriceId        String?
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean            @default(false)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
}

model UsageStats {
  id              String   @id @default(cuid())
  userId          String
  month           DateTime // First day of the month
  aiResponseCount Int      @default(0)
  tokensUsed      Int      @default(0)
  reviewsScanned  Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, month])
  @@index([userId])
}

// ==================== Business & Locations ====================

enum Platform {
  GOOGLE_BUSINESS_PROFILE
  ZALO_OA
  FACEBOOK
}

model Business {
  id          String   @id @default(cuid())
  userId      String
  name        String
  description String?
  category    String?
  phone       String?
  website     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  locations Location[]

  @@index([userId])
}

model Location {
  id         String   @id @default(cuid())
  businessId String
  name       String
  address    String
  city       String?
  district   String?
  latitude   Float?
  longitude  Float?
  phone      String?
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  business            Business             @relation(fields: [businessId], references: [id], onDelete: Cascade)
  platformConnections PlatformConnection[]
  reviews             Review[]
  analytics           LocationAnalytics[]

  @@index([businessId])
}

model PlatformConnection {
  id             String   @id @default(cuid())
  locationId     String
  platform       Platform
  externalId     String   // GBP Place ID or Zalo OA ID
  accessToken    String?  @db.Text
  refreshToken   String?  @db.Text
  tokenExpiresAt DateTime?
  isConnected    Boolean  @default(true)
  lastSyncAt     DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([locationId, platform])
  @@index([locationId])
  @@index([platform])
}

// ==================== Reviews & Responses ====================

enum Sentiment {
  POSITIVE
  NEUTRAL
  NEGATIVE
}

enum ReviewStatus {
  NEW
  PENDING_RESPONSE
  AI_DRAFT_READY
  RESPONDED
  IGNORED
}

model Review {
  id              String       @id @default(cuid())
  locationId      String
  platform        Platform
  externalId      String       // Review ID from platform
  authorName      String
  authorPhotoUrl  String?
  rating          Int          // 1-5 stars
  content         String?      @db.Text
  sentiment       Sentiment    @default(NEUTRAL)
  sentimentScore  Float?       // -1 to 1
  keywords        String[]     // Extracted keywords
  status          ReviewStatus @default(NEW)
  publishedAt     DateTime
  fetchedAt       DateTime     @default(now())
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  location  Location   @relation(fields: [locationId], references: [id], onDelete: Cascade)
  responses Response[]

  @@unique([platform, externalId])
  @@index([locationId])
  @@index([platform])
  @@index([sentiment])
  @@index([status])
  @@index([publishedAt])
}

enum ResponseStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  PUBLISHED
  REJECTED
}

enum ToneType {
  FRIENDLY
  PROFESSIONAL
  EMPATHETIC
  CONCISE
  FORMAL
}

model Response {
  id            String         @id @default(cuid())
  reviewId      String
  content       String         @db.Text
  tone          ToneType       @default(PROFESSIONAL)
  isAiGenerated Boolean        @default(true)
  status        ResponseStatus @default(DRAFT)
  tokensUsed    Int?
  modelUsed     String?        // e.g., "gpt-4o-mini", "gemini-1.5-flash"
  approvedAt    DateTime?
  publishedAt   DateTime?
  rejectedAt    DateTime?
  rejectionNote String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@index([reviewId])
  @@index([status])
}

// ==================== Response Templates ====================

model ResponseTemplate {
  id          String    @id @default(cuid())
  userId      String?   // null = system template
  name        String
  description String?
  content     String    @db.Text
  tone        ToneType  @default(PROFESSIONAL)
  forSentiment Sentiment?
  forRating   Int?      // 1-5, null = all
  isActive    Boolean   @default(true)
  usageCount  Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([tone])
  @@index([forSentiment])
}

// ==================== Analytics ====================

model LocationAnalytics {
  id              String   @id @default(cuid())
  locationId      String
  date            DateTime @db.Date
  totalReviews    Int      @default(0)
  newReviews      Int      @default(0)
  avgRating       Float?
  positiveCount   Int      @default(0)
  neutralCount    Int      @default(0)
  negativeCount   Int      @default(0)
  responsesCount  Int      @default(0)
  avgResponseTime Float?   // in hours
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([locationId, date])
  @@index([locationId])
  @@index([date])
}

// ==================== AI Review Detection ====================

model ReviewAuthenticityCheck {
  id              String   @id @default(cuid())
  reviewId        String   @unique
  isSuspicious    Boolean  @default(false)
  suspicionScore  Float?   // 0-1, higher = more suspicious
  flags           String[] // e.g., ["new_account", "generic_text", "bulk_posting"]
  analysisDetails Json?
  checkedAt       DateTime @default(now())

  @@index([isSuspicious])
  @@index([suspicionScore])
}
