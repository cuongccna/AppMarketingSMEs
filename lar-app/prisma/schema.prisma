// Prisma Schema for LAR - Local AI Responder
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== Authentication ====================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  password      String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts      Account[]
  sessions      Session[]
  businesses    Business[]
  subscription  Subscription?
  usageStats    UsageStats[]
  settings      UserSettings?
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ==================== User Settings ====================

model UserSettings {
  id                     String   @id @default(cuid())
  userId                 String   @unique
  
  // Profile
  phone                  String?
  company                String?
  
  // Notification Settings
  emailNewReview         Boolean  @default(true)
  emailNegativeReview    Boolean  @default(true)
  emailWeeklyReport      Boolean  @default(true)
  zaloNewReview          Boolean  @default(false)
  zaloNegativeReview     Boolean  @default(true)
  pushEnabled            Boolean  @default(false)
  
  // AI Tone Settings
  defaultTone            String   @default("FRIENDLY")
  customInstructions     String?  @db.Text
  includeBusinessName    Boolean  @default(true)
  includeManagerSignature Boolean @default(false)
  managerName            String?
  
  // AI Model Settings
  preferredModel         String   @default("gpt-4o-mini")
  autoGenerateResponses  Boolean  @default(false)
  
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ==================== Subscription & Pricing ====================

enum SubscriptionPlan {
  FREE
  ESSENTIAL
  PROFESSIONAL
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  TRIALING
}

model Subscription {
  id                   String             @id @default(cuid())
  userId               String             @unique
  plan                 SubscriptionPlan   @default(FREE)
  status               SubscriptionStatus @default(ACTIVE)
  stripeCustomerId     String?
  stripeSubscriptionId String?
  stripePriceId        String?
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean            @default(false)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
}

model UsageStats {
  id              String   @id @default(cuid())
  userId          String
  month           DateTime // First day of the month
  aiResponseCount Int      @default(0)
  tokensUsed      Int      @default(0)
  reviewsScanned  Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, month])
  @@index([userId])
}

// ==================== Business & Locations ====================

enum Platform {
  GOOGLE_BUSINESS_PROFILE
  ZALO_OA
  FACEBOOK
}

model Business {
  id          String   @id @default(cuid())
  userId      String
  name        String
  description String?
  category    String?
  phone       String?
  website     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  locations Location[]
  customers Customer[]

  @@index([userId])
}

model Location {
  id         String   @id @default(cuid())
  businessId String
  name       String
  address    String
  city       String?
  district   String?
  latitude   Float?
  longitude  Float?
  phone      String?
  coverImage String?  // URL to cover image
  pointsPerReview Int @default(10) // Points awarded per review
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  business            Business             @relation(fields: [businessId], references: [id], onDelete: Cascade)
  platformConnections PlatformConnection[]
  reviews             Review[]
  rewards             Reward[]
  analytics           LocationAnalytics[]

  @@index([businessId])
}

model PlatformConnection {
  id             String   @id @default(cuid())
  locationId     String
  platform       Platform
  externalId     String   // GBP Place ID or Zalo OA ID
  platformName   String?  // Name of connected account (OA name, GBP business name)
  accessToken    String?  @db.Text
  refreshToken   String?  @db.Text
  tokenExpiresAt DateTime?
  isConnected    Boolean  @default(true)
  lastSyncAt     DateTime?
  metadata       Json?    // Additional platform-specific data
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([locationId, platform])
  @@index([locationId])
  @@index([platform])
}

// ==================== Reviews & Responses ====================

enum Sentiment {
  POSITIVE
  NEUTRAL
  NEGATIVE
}

enum ReviewStatus {
  NEW
  PENDING_RESPONSE
  AI_DRAFT_READY
  RESPONDED
  IGNORED
}

model Review {
  id              String       @id @default(cuid())
  locationId      String
  platform        Platform
  externalId      String       // Review ID from platform
  authorName      String
  authorPhotoUrl  String?
  zaloUserId      String?      // Zalo User ID for Mini App reviews
  customerId      String?      // Link to CRM Customer
  rating          Int          // 1-5 stars
  content         String?      @db.Text
  sentiment       Sentiment    @default(NEUTRAL)
  sentimentScore  Float?       // -1 to 1
  keywords        String[]     // Extracted keywords
  status          ReviewStatus @default(NEW)
  publishedAt     DateTime
  fetchedAt       DateTime     @default(now())
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  location  Location   @relation(fields: [locationId], references: [id], onDelete: Cascade)
  customer  Customer?  @relation(fields: [customerId], references: [id])
  responses Response[]

  @@unique([platform, externalId])
  @@index([locationId])
  @@index([platform])
  @@index([sentiment])
  @@index([status])
  @@index([publishedAt])
  @@index([zaloUserId])
  @@index([customerId])
}

enum ResponseStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  PUBLISHED
  REJECTED
}

enum ToneType {
  FRIENDLY
  PROFESSIONAL
  EMPATHETIC
  CONCISE
  FORMAL
}

model Response {
  id            String         @id @default(cuid())
  reviewId      String
  content       String         @db.Text
  tone          ToneType       @default(PROFESSIONAL)
  isAiGenerated Boolean        @default(true)
  status        ResponseStatus @default(DRAFT)
  tokensUsed    Int?
  modelUsed     String?        // e.g., "gpt-4o-mini", "gemini-1.5-flash"
  approvedAt    DateTime?
  publishedAt   DateTime?
  rejectedAt    DateTime?
  rejectionNote String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@index([reviewId])
  @@index([status])
}

// ==================== Response Templates ====================

model ResponseTemplate {
  id          String    @id @default(cuid())
  userId      String?   // null = system template
  name        String
  description String?
  content     String    @db.Text
  tone        ToneType  @default(PROFESSIONAL)
  forSentiment Sentiment?
  forRating   Int?      // 1-5, null = all
  isActive    Boolean   @default(true)
  usageCount  Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([tone])
  @@index([forSentiment])
}

// ==================== Analytics ====================

model LocationAnalytics {
  id              String   @id @default(cuid())
  locationId      String
  date            DateTime @db.Date
  totalReviews    Int      @default(0)
  newReviews      Int      @default(0)
  avgRating       Float?
  positiveCount   Int      @default(0)
  neutralCount    Int      @default(0)
  negativeCount   Int      @default(0)
  responsesCount  Int      @default(0)
  avgResponseTime Float?   // in hours
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([locationId, date])
  @@index([locationId])
  @@index([date])
}

// ==================== AI Review Detection ====================

model ReviewAuthenticityCheck {
  id              String   @id @default(cuid())
  reviewId        String   @unique
  isSuspicious    Boolean  @default(false)
  suspicionScore  Float?   // 0-1, higher = more suspicious
  flags           String[] // e.g., ["new_account", "generic_text", "bulk_posting"]
  analysisDetails Json?
  checkedAt       DateTime @default(now())

  @@index([isSuspicious])
  @@index([suspicionScore])
}

// ==================== Loyalty System ====================

model Customer {
  id            String   @id @default(cuid())
  businessId    String?
  zaloId        String?
  name          String?
  phone         String?
  email         String?
  avatar        String?
  points        Int      @default(0)
  level         String   @default("MEMBER") // MEMBER, SILVER, GOLD, PLATINUM
  notes         String?  @db.Text
  tags          String[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  business      Business? @relation(fields: [businessId], references: [id], onDelete: Cascade)
  transactions  PointTransaction[]
  notifications Notification[]
  redemptions   Redemption[]
  reviews       Review[]

  @@unique([businessId, zaloId])
  @@index([businessId])
  @@index([phone])
  @@index([email])
}

model PointTransaction {
  id          String   @id @default(cuid())
  customerId  String
  amount      Int      // Positive for earning, negative for spending
  type        String   // REVIEW, PURCHASE, BONUS, REDEEM
  description String?
  createdAt   DateTime @default(now())

  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
}

// ==================== Notifications ====================

enum NotificationType {
  SYSTEM
  PROMOTION
  ORDER
  REVIEW
}

model Notification {
  id          String           @id @default(cuid())
  title       String
  content     String           @db.Text
  image       String?
  type        NotificationType @default(SYSTEM)
  customerId  String?          // null = global notification
  isRead      Boolean          @default(false)
  createdAt   DateTime         @default(now())

  customer    Customer?        @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([createdAt])
}

// ==================== Loyalty & Rewards ====================

model Reward {
  id            String   @id @default(cuid())
  locationId    String
  name          String
  description   String?
  image         String?
  pointsRequired Int
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  location      Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  redemptions   Redemption[]

  @@index([locationId])
}

enum RedemptionStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

model Redemption {
  id            String           @id @default(cuid())
  code          String           @unique // Unique redemption code for QR
  customerId    String
  rewardId      String
  pointsSpent   Int
  status        RedemptionStatus @default(PENDING)
  note          String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  customer      Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  reward        Reward   @relation(fields: [rewardId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([rewardId])
  @@index([status])
  @@index([code])
}
